<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡¨å–®åˆ—å°å·¥å…· V4</title>
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF and dom-to-image for high-fidelity PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>

    <style>
        :root {
            --a4-width-px: 794px;
            --a4-height-px: 1123px;
            --a4-width: 210mm;
            --a4-height: 297mm;
            --sidebar-width: 60px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #e9ecef;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            color: #333;
            display: flex;
            min-height: 100vh;
        }

        /* ===== Sidebar Navigation ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            border: none;
            background: transparent;
            color: #bdc3c7;
            font-size: 24px;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: #34495e;
            color: white;
        }

        .nav-btn.active {
            background: #3498db;
            color: white;
        }

        /* ===== Main Content Area ===== */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
        }

        /* ===== View Sections ===== */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* ===== Layout Wrapper ===== */
        .layout-wrapper {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        /* ===== Side Panel ===== */
        .side-panel {
            width: 280px;
            min-width: 280px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        .control-group input[type="file"] {
            width: 100%;
        }

        button {
            background-color: #2196F3;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            font-size: 14px;
            transition: background 0.2s;
        }

        button.secondary {
            background-color: #757575;
        }

        button.success {
            background-color: #4CAF50;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* ===== A4 Page Container ===== */
        .page-wrapper {
            flex: 1;
            min-width: 300px;
            overflow: auto;
        }

        .page-container {
            width: var(--a4-width);
            height: var(--a4-height);
            background: white;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            background-color: #ffffff;
            border: 2px dashed #ff6b6b;
            transform-origin: top left;
        }

        .background-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        /* ===== Draggable Labels ===== */
        .draggable {
            position: absolute;
            border: 2px dashed #2196F3;
            background: rgba(33, 150, 243, 0.1);
            cursor: move;
            z-index: 1;
            writing-mode: vertical-rl;
            text-orientation: upright;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 20px;
            width: 60px;
            height: 200px;
            overflow: hidden;
            resize: both;
            touch-action: none;
            /* Important for touch dragging */
        }

        .draggable .content {
            white-space: nowrap;
            pointer-events: none;
        }

        .grid-label {
            position: absolute;
            top: -25px;
            right: 0;
            left: 0;
            background: #2196F3;
            color: white;
            font-size: 12px;
            padding: 2px 5px;
            text-align: center;
            pointer-events: none;
            writing-mode: horizontal-tb;
        }

        /* Clean styles for export */
        .draggable.clean-mode {
            border: none !important;
            background: transparent !important;
            resize: none !important;
        }

        .grid-label.clean-mode {
            display: none !important;
        }

        .page-container.export-mode {
            border: none !important;
        }

        .draggable.top-align {
            justify-content: flex-start;
            align-items: center;
        }

        /* ===== Hidden Buffer ===== */
        #render-buffer {
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0;
            pointer-events: none;
            z-index: -1000;
        }

        /* ===== Alert Box ===== */
        .alert {
            padding: 10px;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        /* ===== Progress Overlay ===== */
        #progress-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .progress-bar {
            width: 300px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            border: 1px solid #555;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.1s;
        }

        .status-text {
            font-size: 18px;
            font-weight: bold;
        }

        /* ===== Preview List ===== */
        #preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .preview-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .preview-card-header {
            padding: 8px;
            background: #eee;
            font-weight: bold;
        }

        /* ===== RWD: Mobile Styles ===== */
        @media (max-width: 900px) {
            .layout-wrapper {
                flex-direction: column;
            }

            .side-panel {
                width: 100%;
                min-width: unset;
            }

            .page-wrapper {
                width: 100%;
                overflow-x: auto;
            }

            .page-container {
                transform: scale(0.45);
                margin-bottom: -55%;
            }
        }

        @media (max-width: 600px) {

            /* Move sidebar to bottom on mobile */
            .sidebar {
                width: 100%;
                height: 60px;
                flex-direction: row;
                justify-content: center;
                bottom: 0;
                top: auto;
                padding: 5px 0;
            }

            .nav-btn {
                margin: 0 10px;
            }

            .main-content {
                margin-left: 0;
                margin-bottom: 70px;
                width: 100%;
                padding: 10px;
            }

            .page-container {
                transform: scale(0.35);
                margin-bottom: -65%;
            }

            .side-panel h3 {
                font-size: 1.1em;
            }
        }
    </style>
</head>

<body>

    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <button class="nav-btn active" onclick="switchView('config')" title="ç‰ˆé¢è¨­å®š">
            âš™ï¸
        </button>
        <button class="nav-btn" onclick="switchView('preview')" title="é è¦½èˆ‡ä¸‹è¼‰">
            ğŸ“„
        </button>
    </nav>

    <!-- Main Content -->
    <div class="main-content">

        <!-- Progress Overlay -->
        <div id="progress-overlay">
            <div class="status-text" id="status-text">æº–å‚™ä¸­...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div style="margin-top: 10px; font-size: 14px; color: #ccc;">è«‹å‹¿é—œé–‰è¦–çª—</div>
        </div>

        <!-- VIEW 1: CONFIGURATION -->
        <div id="view-config" class="view-section active">
            <div class="layout-wrapper">
                <div class="side-panel">
                    <h3>âš™ï¸ ç‰ˆé¢è¨­å®š</h3>

                    <div class="alert">
                        è«‹å…ˆä¸Šå‚³èƒŒæ™¯åœ–ç‰‡ï¼Œç¢ºä¿ PDF è¼¸å‡ºæ­£ç¢ºã€‚
                    </div>

                    <div class="control-group">
                        <label>1. ä¸Šå‚³èƒŒæ™¯åœ–ç‰‡</label>
                        <input type="file" id="bgInput" accept="image/*" onchange="handleBgUpload(this)">
                    </div>

                    <div class="control-group">
                        <label>2. èª¿æ•´æ¨™ç±¤ä½ç½®</label>
                        <p style="font-size: 0.85em; color: #666;">
                            æ‹–æ›³èª¿æ•´ã€Œå§“åã€èˆ‡ã€Œåœ°å€ã€çš„ä½ç½®ã€‚<br>
                            å³ä¸‹è§’å¯èª¿æ•´å¤§å°ã€‚
                        </p>
                    </div>

                    <button class="secondary" onclick="resetPositions()">é‡ç½®ä½ç½®</button>
                </div>

                <div class="page-wrapper">
                    <div class="page-container" id="editor-canvas">
                        <img id="editor-bg" class="background-img" alt="Background">

                        <div class="draggable" id="drag-name" style="top: 100px; left: 140mm;">
                            <div class="grid-label">å§“å</div>
                            <span class="content">å§“åæ¸¬è©¦</span>
                        </div>

                        <div class="draggable top-align" id="drag-address" style="top: 100px; left: 170mm;">
                            <div class="grid-label">åœ°å€</div>
                            <span class="content">åœ°å€æ¸¬è©¦</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: PREVIEW & DOWNLOAD -->
        <div id="view-preview" class="view-section">
            <div class="layout-wrapper">
                <div class="side-panel">
                    <h3>ğŸ“„ è³‡æ–™è™•ç†</h3>
                    <div class="control-group">
                        <label>1. ä¸Šå‚³è³‡æ–™ (Excel/CSV)</label>
                        <input type="file" id="dataReader" accept=".xlsx, .xls, .csv" onchange="handleDataUpload(this)">
                    </div>

                    <div class="control-group" id="data-stats" style="display:none;">
                        <label>è³‡æ–™ç‹€æ…‹</label>
                        <p id="record-count">å·²è¼‰å…¥ 0 ç­†è³‡æ–™</p>
                    </div>

                    <button class="success" onclick="startBatchPDF()" id="btn-download" disabled>ä¸‹è¼‰åˆä½µ PDF</button>
                    <p style="font-size: 0.8em; color: #888;">
                        ç³»çµ±æœƒé€é ç”Ÿæˆï¼Œè«‹è€å¿ƒç­‰å€™ã€‚
                    </p>
                </div>

                <div id="preview-list">
                    <div style="padding: 40px; text-align: center; color: #888;">
                        è«‹å…ˆä¸Šå‚³è³‡æ–™æª”æ¡ˆ
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden Buffer Container -->
    <div id="render-buffer"></div>

    <script>
        // --- Global State ---
        let currentBgBase64 = null;
        let loadedData = [];

        // --- Initialization ---
        const fallbackImg = './1768757647251.jpg';
        const imgEl = document.getElementById('editor-bg');
        imgEl.onerror = () => { console.log("Default image not found"); };
        imgEl.src = fallbackImg;

        // --- View Switching ---
        function switchView(viewName) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active'));

            if (viewName === 'config') {
                document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
                document.getElementById('view-config').classList.add('active');
            } else {
                document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
                document.getElementById('view-preview').classList.add('active');
                updatePreview();
            }
        }

        // --- Background Image Handling ---
        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    currentBgBase64 = e.target.result;
                    document.getElementById('editor-bg').src = currentBgBase64;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- Draggable Logic (Mouse + Touch) ---
        function makeDraggable(elmnt) {
            let startX = 0, startY = 0, startTop = 0, startLeft = 0;

            // Mouse events
            elmnt.addEventListener('mousedown', dragStart);
            // Touch events - use passive: false to allow preventDefault
            elmnt.addEventListener('touchstart', dragStart, { passive: false });

            function getScale() {
                // Get the current scale of the page container
                const pageContainer = elmnt.closest('.page-container');
                if (!pageContainer) return 1;
                const transform = window.getComputedStyle(pageContainer).transform;
                if (transform === 'none') return 1;
                const matrix = new DOMMatrix(transform);
                return matrix.a; // scaleX
            }

            function dragStart(e) {
                const rect = elmnt.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                // Check if resizing (bottom-right corner) - skip drag
                const isResizing = (clientX > rect.right - 20 && clientY > rect.bottom - 20);
                if (isResizing) return;

                e.preventDefault();
                e.stopPropagation();

                startX = clientX;
                startY = clientY;
                startTop = elmnt.offsetTop;
                startLeft = elmnt.offsetLeft;

                if (e.touches) {
                    document.addEventListener('touchmove', dragMove, { passive: false });
                    document.addEventListener('touchend', dragEnd);
                } else {
                    document.addEventListener('mousemove', dragMove);
                    document.addEventListener('mouseup', dragEnd);
                }
            }

            function dragMove(e) {
                e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                const scale = getScale();

                // Calculate movement adjusted for scale
                const deltaX = (clientX - startX) / scale;
                const deltaY = (clientY - startY) / scale;

                elmnt.style.top = (startTop + deltaY) + "px";
                elmnt.style.left = (startLeft + deltaX) + "px";
            }

            function dragEnd() {
                document.removeEventListener('mousemove', dragMove);
                document.removeEventListener('mouseup', dragEnd);
                document.removeEventListener('touchmove', dragMove);
                document.removeEventListener('touchend', dragEnd);
            }
        }

        document.querySelectorAll('.draggable').forEach(makeDraggable);

        function resetPositions() {
            const name = document.getElementById('drag-name');
            const addr = document.getElementById('drag-address');
            Object.assign(name.style, { top: '100px', left: '140mm', width: '60px', height: '200px' });
            Object.assign(addr.style, { top: '100px', left: '170mm', width: '60px', height: '200px' });
        }

        // --- Data Handling ---
        async function handleDataUpload(input) {
            if (!input.files.length) return;
            const file = input.files[0];
            loadedData = [];
            document.getElementById('btn-download').disabled = true;

            try {
                loadedData = await readExcelOrCSV(file);
                document.getElementById('data-stats').style.display = 'block';
                document.getElementById('record-count').textContent = `å·²è¼‰å…¥ ${loadedData.length} ç­†è³‡æ–™`;
                document.getElementById('btn-download').disabled = false;
                updatePreview();
            } catch (err) {
                alert('è®€å–æª”æ¡ˆå¤±æ•—: ' + err.message);
            }
        }

        function readExcelOrCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', codepage: 65001 });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(json);
                    } catch (e) { reject(e); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // --- Layout Helper ---
        function getLayoutConfig() {
            const nameEl = document.getElementById('drag-name');
            const addrEl = document.getElementById('drag-address');
            return {
                name: {
                    top: nameEl.style.top,
                    left: nameEl.style.left,
                    width: nameEl.style.width,
                    height: nameEl.style.height
                },
                address: {
                    top: addrEl.style.top,
                    left: addrEl.style.left,
                    width: addrEl.style.width,
                    height: addrEl.style.height
                }
            };
        }

        function createPageElement(row, layout, forExport) {
            let nameVal = '';
            let addrVal = '';
            for (let k in row) {
                const key = k.toString().trim();
                if (key.includes('å§“å') || key.toLowerCase() === 'name') nameVal = row[k];
                if (key.includes('åœ°å€') || key.toLowerCase() === 'address') addrVal = row[k];
            }

            const page = document.createElement('div');
            page.className = 'page-container';
            if (forExport) { page.classList.add('export-mode'); }

            const bg = document.createElement('img');
            bg.src = currentBgBase64 || document.getElementById('editor-bg').src;
            bg.className = 'background-img';
            page.appendChild(bg);

            if (nameVal) {
                const div = document.createElement('div');
                div.className = 'draggable';
                if (forExport) { div.classList.add('clean-mode'); }
                Object.assign(div.style, layout.name);
                div.innerHTML = `<span class="content">${nameVal}</span>`;
                page.appendChild(div);
            }

            if (addrVal) {
                const div = document.createElement('div');
                div.className = 'draggable top-align';
                if (forExport) { div.classList.add('clean-mode'); }
                Object.assign(div.style, layout.address);
                div.innerHTML = `<span class="content">${addrVal}</span>`;
                page.appendChild(div);
            }

            return page;
        }

        function updatePreview() {
            const container = document.getElementById('preview-list');
            container.innerHTML = '';
            if (loadedData.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #888;">è«‹ä¸Šå‚³è³‡æ–™</div>';
                return;
            }

            const layout = getLayoutConfig();
            const previewLimit = Math.min(loadedData.length, 3);

            for (let i = 0; i < previewLimit; i++) {
                const page = createPageElement(loadedData[i], layout, true);
                page.style.transform = "scale(0.3)";
                page.style.transformOrigin = "top left";
                page.style.marginBottom = "-70%";

                const wrapper = document.createElement('div');
                wrapper.className = 'preview-card';
                wrapper.style.width = "240px";
                wrapper.style.height = "350px";
                wrapper.style.overflow = "hidden";

                const header = document.createElement('div');
                header.className = 'preview-card-header';
                header.textContent = `ç¬¬ ${i + 1} ç­†`;

                wrapper.appendChild(header);
                wrapper.appendChild(page);
                container.appendChild(wrapper);
            }

            if (loadedData.length > 3) {
                const more = document.createElement('div');
                more.style.padding = "20px";
                more.style.color = "#666";
                more.textContent = `... é‚„æœ‰ ${loadedData.length - 3} ç­†è³‡æ–™`;
                container.appendChild(more);
            }
        }

        // --- Batch PDF Generation ---
        async function startBatchPDF() {
            if (loadedData.length === 0) return;

            if (!currentBgBase64) {
                alert("è«‹å…ˆä¸Šå‚³èƒŒæ™¯åœ–ç‰‡ï¼\n\nè«‹åˆ‡æ›è‡³ã€Œè¨­å®šã€é é¢ï¼Œé¸å–èƒŒæ™¯åœ–ç‰‡ã€‚");
                switchView('config');
                const bgInput = document.getElementById('bgInput');
                bgInput.style.border = "3px solid red";
                bgInput.style.backgroundColor = "#ffe6e6";
                return;
            }

            const overlay = document.getElementById('progress-overlay');
            const statusText = document.getElementById('status-text');
            const progressFill = document.getElementById('progress-fill');
            const buffer = document.getElementById('render-buffer');

            overlay.style.display = 'flex';
            statusText.textContent = "åˆå§‹åŒ–...";
            progressFill.style.width = "0%";

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const layout = getLayoutConfig();
            const total = loadedData.length;

            try {
                for (let i = 0; i < total; i++) {
                    statusText.textContent = `è™•ç†ä¸­ ${i + 1}/${total}`;
                    progressFill.style.width = Math.round((i / total) * 100) + "%";

                    buffer.innerHTML = '';
                    const pageEl = createPageElement(loadedData[i], layout, true);
                    buffer.appendChild(pageEl);

                    await waitForImages(pageEl);

                    // 3x resolution
                    const scale = 3;
                    const pageWidth = pageEl.offsetWidth;
                    const pageHeight = pageEl.offsetHeight;

                    const imgData = await domtoimage.toJpeg(pageEl, {
                        quality: 0.95,
                        bgcolor: '#ffffff',
                        width: pageWidth * scale,
                        height: pageHeight * scale,
                        style: {
                            transform: `scale(${scale})`,
                            transformOrigin: 'top left'
                        }
                    });

                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = doc.internal.pageSize.getHeight();

                    if (i > 0) doc.addPage();
                    doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

                    await new Promise(r => setTimeout(r, 30));
                }

                statusText.textContent = "å„²å­˜ä¸­...";
                progressFill.style.width = "100%";
                await new Promise(r => setTimeout(r, 100));

                doc.save('form-output.pdf');

            } catch (err) {
                console.error(err);
                alert("éŒ¯èª¤: " + err.message);
            } finally {
                buffer.innerHTML = '';
                overlay.style.display = 'none';
            }
        }

        function waitForImages(element) {
            const imgs = element.querySelectorAll('img');
            const promises = [];
            imgs.forEach(img => {
                if (!img.complete) {
                    promises.push(new Promise(resolve => {
                        img.onload = resolve;
                        img.onerror = resolve;
                    }));
                }
            });
            return Promise.all(promises);
        }
    </script>
</body>

</html>